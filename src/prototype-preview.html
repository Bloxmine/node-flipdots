<!DOCTYPE html>
<html>
<head>
  <title>FlipDot Prototype Display</title>
  <style>
    :root {
        --color-white: #fff;
        --color-black: #000;
        --color-dark-bg: #0a0a0a;
        --color-darker-bg: #111;
        --color-medium-bg: #222;
        --color-border-dark: #333;
        --color-border-medium: #444;
        --color-border-light: #666;
        --color-border-lighter: #888;
        --color-text-light: #ccc;
        --color-button-bg: #444;
        --color-button-hover: #666;
        --color-restart-bg: #633;
        --color-restart-border: #855;
        --color-restart-hover: #855;
        --color-restart-hover-border: #a77;
        --color-shadow: rgba(255,255,255,0.1);
        --color-debug: #fa0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        min-height: 100vh;
        padding: 20px;
        color: var(--color-white);
        font-family: monospace;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: url('/images/background.jpg') center/cover no-repeat fixed;
        background-color: var(--color-black);
    }

    h1 { margin-bottom: 20px; text-align: center; }
    h3 { margin-bottom: 15px; color: var(--color-text-light); }

    .display-container {
        border: 4px solid var(--color-border-dark);
        border-radius: 8px;
        padding: 20px;
        background: var(--color-darker-bg);
        box-shadow: 0 0 20px var(--color-shadow);
    }

    #prototypeDisplay {
        border: 2px solid var(--color-border-medium);
        border-radius: 4px;
        background: var(--color-dark-bg);
        display: block;
    }

    .game-controls {
        margin-top: 20px;
        text-align: center;
    }

    .action-buttons {
        margin-top: 20px;
    }

    .action-btn {
        background: var(--color-button-bg);
        color: var(--color-white);
        border: 2px solid var(--color-border-light);
        padding: 12px 24px;
        margin: 0 10px;
        border-radius: 8px;
        cursor: pointer;
        font-family: monospace;
        font-size: 14px;
        transition: all 0.1s;
    }

    .action-btn:hover {
        background: var(--color-button-hover);
        border-color: var(--color-border-lighter);
    }

    .action-btn.restart {
        background: var(--color-restart-bg);
        border-color: var(--color-restart-border);
    }

    .action-btn.restart:hover {
        background: var(--color-restart-hover);
        border-color: var(--color-restart-hover-border);
    }

    .status-display {
        margin-top: 15px;
        padding: 10px;
        background: var(--color-medium-bg);
        border-radius: 4px;
        font-size: 12px;
        color: var(--color-text-light);
        max-width: 600px;
    }
  </style>
</head>
<body>
  <h1>PAC-XON: Flipdot Edition</h1>
  
  <div class="display-container">
    <canvas id="prototypeDisplay"></canvas>
  </div>
  
  <div class="game-controls">
    <h3>Game Controls</h3>
    <div class="action-buttons">
      <button class="action-btn restart" onclick="sendCommand('RESTART')">Restart Game (R)</button>
    </div>
    
    <div class="status-display" id="gameStatus">Game Status: Loading...</div>
    
    <h3 style="margin-top: 30px; color: #fa0;">Debug Controls</h3>
    <div class="action-buttons">
      <button class="action-btn" onclick="sendCommand('NEXT_LEVEL')">Next Level (N)</button>
      <button class="action-btn" onclick="sendCommand('ADD_LIFE')" style="background: #363; border-color: #585;">Add Life (+)</button>
      <button class="action-btn" onclick="sendCommand('LOSE_LIFE')" style="background: #633; border-color: #855;">Lose Life (-)</button>
    </div>
  </div>
  <div style="height: 40px;">
    <div id="howtoPlay" style="margin-top: 20px; color: var(--color-text-light); font-size: 12px; text-align: center;">
      Use Arrow Keys or WASD to move Pac-Man. 
      <br>For full instructions, refer to the physical manual.
    </div>
  </div>
  
  <audio id="audio0" src="/audio/pacman_beginning.wav" preload="auto"></audio>
  <audio id="audio1" src="/audio/pacman_chomp.wav" preload="auto"></audio>
  <audio id="audio2" src="/audio/pacman_death.wav" preload="auto"></audio>
  <audio id="audio3" src="/audio/pacman_intermission.wav" preload="auto"></audio>
  <audio id="audio4" src="/audio/pacman_extrapac.wav" preload="auto"></audio>
  <audio id="audio5" src="/audio/pacman_tutorial.mp3" loop preload="auto"></audio>
  <audio id="audio6" src="/audio/gameplay.mp3" loop preload="auto"></audio>
  
  <script>
    const canvas = document.getElementById('prototypeDisplay');
    const ctx = canvas.getContext('2d');
    let consecutiveErrors = 0;
    const MAX_ERRORS = 3;
    const UPDATE_INTERVAL = 100;
    const STATUS_INTERVAL = 500;
    
    // Audio setup
    const audioElements = {
      'pacman_beginning.wav': document.getElementById('audio0'),
      'pacman_chomp.wav': document.getElementById('audio1'),
      'pacman_death.wav': document.getElementById('audio2'),
      'pacman_intermission.wav': document.getElementById('audio3'),
      'pacman_extrapac.wav': document.getElementById('audio4'),
      'pacman_tutorial.mp3': document.getElementById('audio5'),
      'gameplay.mp3': document.getElementById('audio6')
    };
    
    let lastSoundTime = {};
    
    function playSound(soundName) {
      const audio = audioElements[soundName];
      if (!audio) return;
      
      // Don't restart background music if playing
      if ((soundName.includes('gameplay') || soundName.includes('tutorial')) && 
          !audio.paused && audio.currentTime > 0) {
        return;
        }
      
      audio.pause();
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }
    
    function stopSound(soundName) {
      const audio = audioElements[soundName];
      if (!audio) return;
      audio.pause();
      audio.currentTime = 0;
    }
    
    async function updateDisplay() {
      try {
        const response = await fetch('/frame-raw');
        if (!response.ok) throw new Error('HTTP ' + response.status);
        
        const width = parseInt(response.headers.get('X-Canvas-Width'));
        const height = parseInt(response.headers.get('X-Canvas-Height'));
        
        if (canvas.width !== width || canvas.height !== height) {
          canvas.width = width;
          canvas.height = height;
        }
        
        const buffer = await response.arrayBuffer();
        const pixelData = new Uint8ClampedArray(buffer);
        const imageData = new ImageData(pixelData, width, height);
        ctx.putImageData(imageData, 0, 0);
        
        consecutiveErrors = 0;
      } catch (error) {
        consecutiveErrors++;
        if (consecutiveErrors >= MAX_ERRORS) {
          console.warn('Multiple errors updating display:', error.message);
        }
      }
    }
    
    function sendCommand(command) {
      fetch('/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command })
      }).catch(console.error);
    }
    
    // Keyboard controls
    const keyMap = {
      'arrowup': 'UP', 'w': 'UP',
      'arrowdown': 'DOWN', 's': 'DOWN',
      'arrowleft': 'LEFT', 'a': 'LEFT',
      'arrowright': 'RIGHT', 'd': 'RIGHT',
      'r': 'RESTART',
      'n': 'NEXT_LEVEL',
      '+': 'ADD_LIFE', '=': 'ADD_LIFE',
      '-': 'LOSE_LIFE', '_': 'LOSE_LIFE'
    };
    
    document.addEventListener('keydown', (e) => {
      const command = keyMap[e.key.toLowerCase()];
      if (command) {
        sendCommand(command);
        e.preventDefault();
      }
    });
    
    // init
    updateDisplay();
    setInterval(updateDisplay, UPDATE_INTERVAL);
    
    setInterval(() => {
      fetch('/status')
        .then(r => r.text())
        .then(s => document.getElementById('gameStatus').textContent = s || 'Game Status: Running...')
        .catch(() => document.getElementById('gameStatus').textContent = 'Game Status: Connection Error');
    }, STATUS_INTERVAL);
    
    setInterval(() => {
      fetch('/sound-event')
        .then(r => r.json())
        .then(d => {
          if (d.sound) playSound(d.sound);
          if (d.stop) stopSound(d.stop);
        })
        .catch(() => {});
    }, UPDATE_INTERVAL);
    
    document.addEventListener('DOMContentLoaded', () => {
      document.body.tabIndex = 0;
      document.body.focus();
    });
  </script>
</body>
</html>
